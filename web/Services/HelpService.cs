
using LC.Newtonsoft.Json;
using LeanCloud;
using LeanCloud.Common;
using LeanCloud.Storage;
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Threading;
using System.Threading.Tasks;


public static class HelpService 
{
    public static string DeviceTable = "DeviceInfos";
    public static string StartGameTable = "StartGameInfos";
    public static string GameConfigTable = "GameConfig";
    public static string PlayerPropsTable = "PlayerProps";
    public static string SpecialDollsTable = "SpecialDolls";

    public static string ON_LOGIN = "100000";
    public static string ON_SIGUP = "100001";
    public static string START_GAME = "100002";

    public static string CONSUME_POWER_FAILURE = "100100";


    public static T ConvertTo<T>(this object obj)
    {
        if (obj == null)
            return default(T);

        if (obj is T t)
            return t;

        try
        {
            return (T)Convert.ChangeType(obj, typeof(T));
        }
        catch
        {
            return default(T);
        }
    }

    //private static T ConvertTo<T>(object value)
    //{
    //    if (value == null)
    //        return default(T);

    //    if (value is T t)
    //        return t;

    //    try
    //    {
    //        return (T)Convert.ChangeType(value, typeof(T));
    //    }
    //    catch
    //    {
    //        return default(T);
    //    }
    //}

    private static async Task<LCUser> GetUser(string objectId)
    {
        LCQuery<LCUser> query = LCUser.GetQuery();
        query.WhereEqualTo("objectId", objectId);
        LCUser user = await query.First();
        return user;
    }
    private static async Task<bool> isOnline(string objectId) 
    {
        LCUser user = await GetUser(objectId);
        return user["online"].ConvertTo<bool>();
    }
    
    public static async Task UserSetupPointer(string userId,string key,LCObject lcobject)
    {
        LCUser user = await GetUser(userId);
        user[key] = lcobject;
        await user.Save();
    }

    public static async Task<bool> ValidateClientID(string clientUserId,string parametersClientUserId)
    {
        bool success = false;
        try
        {
            bool online = await isOnline(clientUserId);
            if (online)
            {
                //—È÷§
                if (clientUserId == parametersClientUserId)
                {
                    success = true;
                }
            }
            else {
                success = false;
            }
        }
        catch
        {
            success=false;
        }
        return success;
    }
    public static LCACL SetupACL(string clientUserId) 
    {
        LCACL acl = new LCACL();
        acl.SetUserIdReadAccess(clientUserId, true);
        acl.SetUserIdWriteAccess(clientUserId, true);
        acl.SetUserIdReadAccess(SysIMClientService.Inst.SysIMClient.Id, true);
        acl.SetUserIdWriteAccess(SysIMClientService.Inst.SysIMClient.Id, true);
        return acl;
    }
    public static async Task<LCObject> CreateStartGameInfo(Dictionary<string,object> dic) 
    {
        LCQuery<LCObject> devQuery = new LCQuery<LCObject>(HelpService.StartGameTable);
        devQuery.WhereEqualTo("userId", dic["userId"]);
        devQuery.WhereEqualTo("userName", dic["userName"]);
        devQuery.OrderByDescending("createdAt");
        ReadOnlyCollection<LCObject> sGameTables = await devQuery.Find();

        if (sGameTables.Count > 10)
        {
            await sGameTables[9].Delete();
        }


        LCObject startGameInfo = new LCObject(StartGameTable);
        foreach (KeyValuePair<string, object> kv in dic)
        {
            startGameInfo[kv.Key] = kv.Value;
        }

        DateTime sysUtcTime = DateTime.ParseExact(
            $"{DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}",
           "yyyy-MM-dd HH:mm:ss",
           System.Globalization.CultureInfo.InvariantCulture,
           System.Globalization.DateTimeStyles.AssumeUniversal
       );
        DateTime sysLocalTime = DateTime.ParseExact(
             $"{DateTime.Now:yyyy-MM-dd HH:mm:ss}",
            "yyyy-MM-dd HH:mm:ss",
            System.Globalization.CultureInfo.InvariantCulture,
            System.Globalization.DateTimeStyles.AssumeUniversal
        );

        startGameInfo["sysUtc"] = sysUtcTime;
        startGameInfo["sysLocal"] = sysLocalTime;

        startGameInfo.ACL = SetupACL( dic["userId"].ConvertTo<string>() );

        await startGameInfo.Save();

        return startGameInfo;
    }
    public static async Task<LCObject> CreateOrSetupDeviceInfo(Dictionary<string, object> dic) 
    {
        SysIMClientService.Inst.SysIMClient.GetQuery();
        LCQuery<LCObject> devQuery = new LCQuery<LCObject>(DeviceTable);
        devQuery.WhereEqualTo("userId", dic["userId"]);
        devQuery.WhereEqualTo("userName", dic["userName"]);
        LCObject devTable = await devQuery.First();

        if (devTable == null)
        {
            devTable = new LCObject(HelpService.DeviceTable);
            foreach (KeyValuePair<string, object> kv in dic)
            {
                devTable[kv.Key] = kv.Value;
            }
            devTable.ACL = SetupACL( dic["userId"].ConvertTo<string>() );

            await devTable.Save();
        }
        else
        {
            foreach (KeyValuePair<string, object> kv in dic)
            {
                devTable[kv.Key] = kv.Value;
            }
            await devTable.Save();
        }

        return devTable;
    }
    public static async Task<LCObject> CreateDefaultPlayerPropsInfoFromUser(string userId)
    {
        LCObject playerProp = new LCObject(PlayerPropsTable);
        playerProp.ACL = SetupACL(userId);
        await playerProp.Save();
        return playerProp;
    }
    private static async Task<LCObject> GetGameConfigTableInfo()
    {
        LCQuery<LCObject> devQuery = new LCQuery<LCObject>(GameConfigTable);
        LCObject gameConfig = await devQuery.First();
        return gameConfig;
    }
    private static async Task<ReadOnlyCollection<LCObject>> GetSpecialDollsTableInfo()
    {
        LCQuery<LCObject> devQuery = new LCQuery<LCObject>(SpecialDollsTable);
        ReadOnlyCollection<LCObject> objs = await devQuery.Find();
        return objs;
    }
    public static async Task<LCObject> GetPlayerPropsInfoFromUser(string userId)
    {
        LCQuery<LCObject> query = new LCQuery<LCObject>(PlayerPropsTable);
        query.WhereEqualTo("userId", userId);
        var palyerProp = await query.First();
        return palyerProp;
    }
    //public static async Task<T> GetPlayerPropsInfoFromUser<T>(string userId) where T : LCObject
    //{
    //    LCQuery<T> query = new LCQuery<T>(PlayerPropsTable);
    //    query.WhereEqualTo("userId", userId);
    //    var palyerProp = await query.First();
    //    return palyerProp;
    //}

    #region//Power Value
    public static async Task<bool> AddConsumePower(string userId)
    {
        bool success = false;
        LCObject palyerProp = await GetPlayerPropsInfoFromUser(userId);
        if (palyerProp != null)
        {
            LCObject gameConfig = await GetGameConfigTableInfo();
            int addPowerValue = ConvertTo<int>( gameConfig["perAddPower"] );

            int userPower = ConvertTo<int>(palyerProp["power"]);
            userPower += addPowerValue;

            palyerProp["power"] = userPower;
            await palyerProp.Save();
            success = true;
        }
        return success;
    }
    public static async Task<bool> ConsumePower(string userId)
    {
        bool success = false;
        LCObject palyerProp = await GetPlayerPropsInfoFromUser(userId);
        if (palyerProp != null)
        {
            LCObject gameConfig = await GetGameConfigTableInfo();
            int conSumeValue = ConvertTo<int>(gameConfig["perConsumePower"]);
            int userPower = ConvertTo<int>(palyerProp["power"]);
            if (userPower >= conSumeValue)
            {
                userPower -= conSumeValue;
                palyerProp["power"] = userPower;
                await palyerProp.Save();
                success = true;
            }
        }
        return success;
    }
    #endregion

    #region// GoldCoin
    public static async Task<bool> ConsumeGoldCoin(string userId, int consumeCount)
    {
        bool success = false;
        LCObject palyerProp = await GetPlayerPropsInfoFromUser(userId);
        if (palyerProp != null)
        {
            int userGoldCoin = ConvertTo<int>(palyerProp["goldCoin"]);
            if (userGoldCoin>= consumeCount) 
            {
                userGoldCoin -= consumeCount;
            }
            palyerProp["goldCoin"] = userGoldCoin;
            await palyerProp.Save();
            success = true;
        }
        return success;
    }
    public static async Task<bool> AddGoldCoin(string userId,int count) 
    {
        bool success = false;
        LCObject palyerProp = await GetPlayerPropsInfoFromUser(userId);
        if (palyerProp != null)
        {
            int userGoldCoin = ConvertTo<int>(palyerProp["goldCoin"]);
            userGoldCoin += count;

            palyerProp["goldCoin"] = userGoldCoin;
            await palyerProp.Save();
            success = true;
        }
        return success;
    }
    #endregion

    #region// Gem
    public static async Task<bool> ConsumeGem(string userId, int consumeCount)
    {
        bool success = false;
        LCObject palyerProp = await GetPlayerPropsInfoFromUser(userId);
        if (palyerProp != null)
        {
            int userGem = ConvertTo<int>(palyerProp["gem"]);
            if (userGem >= consumeCount)
            {
                userGem -= consumeCount;
            }
            palyerProp["gem"] = userGem;
            await palyerProp.Save();
            success = true;
        }
        return success;
    }
    public static async Task<bool> AddGem(string userId, int count)
    {
        bool success = false;
        LCObject palyerProp = await GetPlayerPropsInfoFromUser(userId);
        if (palyerProp != null)
        {
            int userGem = ConvertTo<int>(palyerProp["gem"]);
            userGem += count;

            palyerProp["gem"] = userGem;
            await palyerProp.Save();
            success = true;
        }
        return success;
    }
    #endregion

    #region //ProbabilityTool 
    public static WeightedGenerator<string> SpecialDollsGenerator { get;private set; }
    public static async Task<bool> SetupSpecialDollsWeight() 
    {
        bool success = false;
        ReadOnlyCollection<LCObject> speDolls = await GetSpecialDollsTableInfo();
        if (speDolls.Count>0) 
        {
            SpecialDollsGenerator = new WeightedGenerator<string>();
            for (int i = 0; i < speDolls.Count; i++)
            {
                string name = ConvertTo<string>(speDolls[i]["dollName"]);
                int weight = ConvertTo<int>(speDolls[i]["weighted"]);
                SpecialDollsGenerator.AddItem(name, weight);
            }
            success = true;
        }
        return success;
    }

    public static async Task<bool> isCreateSpecialDoll() 
    {
        LCObject gameConfig = await GetGameConfigTableInfo();
        int probability = ConvertTo<int>( gameConfig["specialToyProbability"] );
        return ShouldExecute(probability);
    }


    // œﬂ≥Ã±æµÿ¥Ê¥¢µƒRandom µ¿˝£®»∑±£∂‡œﬂ≥Ã∞≤»´£¨±‹√‚÷÷◊”÷ÿ∏¥£©
    private static readonly ThreadLocal<Random> _threadLocalRandom = new ThreadLocal<Random>(
        () => new Random(Guid.NewGuid().GetHashCode()) // ”√GUIDπ˛œ£◊˜Œ™÷÷◊”£¨ΩµµÕ÷ÿ∏¥∏≈¬ 
    );

    /// <summary>
    /// ∏˘æ›∏≈¬ ∞Ÿ∑÷±»≈–∂œ «∑Ò÷¥––
    /// </summary>
    /// <param name="probabilityPercent">∏≈¬ ∞Ÿ∑÷±»£®0-100£¨∞¸∫¨0∫Õ100£©</param>
    /// <returns>true£∫÷¥––£ªfalse£∫≤ª÷¥––</returns>
    /// https://www.doubao.com/thread/w168a32c6ad71453a
    /// <exception cref="ArgumentOutOfRangeException">µ±∏≈¬ ≥¨≥ˆ0-100∑∂Œß ±≈◊≥ˆ</exception>
    private static bool ShouldExecute(int probabilityPercent)
    {
        // –£—È≤Œ ˝∫œ∑®–‘
        if (probabilityPercent < 0 || probabilityPercent > 100)
        {
            throw new ArgumentOutOfRangeException(
                nameof(probabilityPercent),
                "∏≈¬ ∞Ÿ∑÷±»±ÿ–Î‘⁄0-100÷Æº‰"
            );
        }

        // ±ﬂΩÁ«Èøˆ”≈ªØ£∫0%“ª∂®≤ª÷¥––£¨100%“ª∂®÷¥––£®Œﬁ–Ë…˙≥…ÀÊª˙ ˝£©
        if (probabilityPercent == 0) return false;
        if (probabilityPercent == 100) return true;

        // ◊™ªªŒ™0-1÷Æº‰µƒ∏≈¬ ÷µ£®¿˝»Á30% °˙ 0.3£©
        double probability = probabilityPercent / 100.0;

        // …˙≥…[0.0, 1.0)µƒÀÊª˙ ˝£¨»Ù–°”⁄ƒø±Í∏≈¬ ‘Ú∑µªÿtrue
        return _threadLocalRandom.Value.NextDouble() < probability;
    }
    #endregion

}